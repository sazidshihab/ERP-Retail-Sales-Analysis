name: Run with VPN

on:
  workflow_dispatch:  # manual trigger, can change to push/pull_request etc.

jobs:
  vpn-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install WireGuard & Python
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard python3 python3-pip

      - name: Configure WireGuard
        run: |
          cat <<EOF > wg0.conf
          [Interface]
          PrivateKey = ${{ secrets.WG_PRIVATE_KEY }}
          Address = ${{ secrets.WG_ADDRESS }}
          DNS = 1.1.1.1

          [Peer]
          PublicKey = ${{ secrets.WG_SERVER_PUBLIC_KEY }}
          Endpoint = ${{ secrets.WG_ENDPOINT }}
          AllowedIPs = ${{ secrets.WG_ALLOWED_IPS }}
          PersistentKeepalive = 25
          EOF

      - name: Start WireGuard
        run: |
          sudo wg-quick up ./wg0.conf
          sudo wg

      - name: Run your script through VPN
        run: |
          python3 script_job.py

      - name: Stop WireGuard
        if: always()
        run: |
          sudo wg-quick down ./wg0.conf
